# Python module for 'topic-discovery': train and test models

## Description

### Use the corpora generated by the Ruby 'topic-discovery' module

* each generated file contains one document (in json format) per line
* example of document structure

    - fields: [id, url, title, **content**, **category**]
        - id: the ES document id
        - url: the document's URL source
        - title: the document's title (extracted from its URL page)
        - content: the document's content (extracted from its URL page)
        - category: the document's manually assigned category
    - mandatory fields: **content**, **category**
    - following example displayed on multiple lines only for clarity

    ```
    {
      "id": "936efc08f0ae581b96308d17eb92831d55113a0f49fbbf116afad651d2ca4ec8",
      "url": "http://www.eurosport.fr/football/serie-a-bresilienne/2012/goianense-botafogo_mtc511219/live.shtml",
      "title": "EN DIRECT / LIVE. Goianense - Botafogo - Série A brésilienne - 4 août 2012",
      "content": "série a brésilienne suivez en live la rencontre de football opposant goianense et botafogo ce match se déroule le août et débute à eurosport propose pour cette rencontre un suivi en direct permettant de connaître l' évolution du score et les actions importantes consultez la fiche détaillée pour goianense ainsi que celle pour botafogo découvrez également toute l' actualité du football calendrier résultats et classements",
      "category": "sport"
    }
    ```

* example of folder structure for two document categories [sport, non-sport], processed with the 'PDLW' cleaners (remove Punctuation, remove Digits, Lowercase entire text, remove extra Whitespaces)

    ```
    /mnt/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
    ./data
    ./data/sport/
    ./data/sport/preprocessed/
    ./data/sport/preprocessed/PDLW/
    ./data/sport/preprocessed/PDLW/sport_train.json
    ./data/sport/preprocessed/PDLW/sport_dev.json
    ./data/sport/preprocessed/PDLW/sport_test.json
    ./data/non-sport/
    ./data/non-sport/preprocessed/
    ./data/non-sport/preprocessed/PDLW/
    ./data/non-sport/preprocessed/PDLW/non-sport_train.json
    ./data/non-sport/preprocessed/PDLW/non-sport_dev.json
    ./data/non-sport/preprocessed/PDLW/non-sport_test.json
    ```

### Train transformation models by using the 'gensim' python library for model dimension reduction

* create a **dictionary**: keep *N* most common words seen in the entire corpus

    ```
    word_id   word      word_count
    -----------------------------------
    329467	  bonjour   14629
    477030	  jeux      134228
    54864     maison    166762
    ```

* train a **TF-IDF** model: each dictionary word is associated with a 'IDF' (*inverse document frequency*) weight

    ```
    word_id   word_IDF_weight
    -----------------------------------
    329467    8.675595545984706
    477030    5.477812955564074
    54864     5.164708025295977
    ```

* train a **LSI** model: each dictionary word is associated with *T* word-topic weights

    ```
    word_id   word_LSI_topic_weights
    -----------------------------------
    329467    [0.00022, 0.00049, 0.00037, ..., -0.00278, 0.0007, 0.00017]
    477030    [0.00221, 0.00406, 0.00331, ..., -0.01614, -0.02676, 0.00916]
    54864     [0.00208, 0.00336, 0.00294, ..., -0.06295, 0.05772, 0.0241]
    ```

### Transform the raw text data

* each document of *m* *known* words (variable length) is transformed into a list of *T* topic weights (fixed length)
* the features are obtained by the dot product between the words' *IDF* weight [1 x *m*] and the *LSI* word-topic weights [*m* x *T*]
* example of document structure after applying a 300-topics *LSI* model

    - fields: [id, url, title, **content**, **category**, **features**]
    - mandatory existing field: **content**
    - new **features** field: the array of 300 floats representing the document's topic weights

    ```
    {
      "id": "936efc08f0ae581b96308d17eb92831d55113a0f49fbbf116afad651d2ca4ec8",
      "url": "http://www.eurosport.fr/football/serie-a-bresilienne/2012/goianense-botafogo_mtc511219/live.shtml",
      "title": "EN DIRECT / LIVE. Goianense - Botafogo - Série A brésilienne - 4 août 2012",
      "content": "série a brésilienne suivez en live la rencontre de football opposant goianense et botafogo ce match se déroule le août et débute à eurosport propose pour cette rencontre un suivi en direct permettant de connaître l' évolution du score et les actions importantes consultez la fiche détaillée pour goianense ainsi que celle pour botafogo découvrez également toute l' actualité du football calendrier résultats et classements",
      "category": "sport",
      "features": [0.02832, -0.01525, 0.01179, 0.01114, -0.00465, -0.008, 0.01005, -0.00499, -0.00411, 0.0124, -0.01721, -0.00087, -0.00397, -0.01209, -0.00299, 0.01902, -0.00585, 0.01529, 0.00888, -0.00991, 0.00804, 0.01055, -0.01189, 0.01149, -0.00273, -0.00986, 0.00387, -0.00877, -0.01642, 0.01911, 0.02927, -0.00526, 0.01441, 0.02177, -0.00109, -0.00062, -0.00017, -0.00292, -0.00979, 0.00442, -0.00083, -0.01265, 0.02042, -0.00227, -0.00175, 0.00137, -0.01096, 0.00679, -0.01313, 0.01634, -0.01437, -0.00029, 0.00377, -0.02218, -0.00123, -0.01269, 0.00041, -0.00273, 0.00082, -0.00881, 0.00548, 0.01159, -0.00842, -0.00148, 0.00857, -0.01069, 8.0e-05, 0.01469, 0.02005, -0.00082, -0.00318, 0.00095, -0.01587, -0.00632, -0.01129, -0.0141, 0.00192, 0.00539, -0.00052, 0.00912, 0.01197, 0.00542, 0.00982, -0.01238, 0.00801, -0.00936, -0.00145, -0.01494, -0.01227, -0.00368, 0.01864, -0.00684, 0.00614, -0.00581, -0.00145, -0.00675, 0.0066, 0.00909, -0.00466, -0.00258, -0.00324, -0.00766, 0.00159, 0.00739, 0.01032, 0.00291, -0.01062, 0.00908, -0.00035, -0.00097, -0.00694, 0.01152, -0.0048, -0.00121, -0.00647, 0.00285, -0.01277, -0.00291, -0.00231, -0.00138, -0.00821, 0.01933, -0.00163, 0.00068, 0.00064, 0.00701, 0.01045, -0.00904, 0.00094, 0.00763, 0.00517, -0.00065, -0.01055, 0.00558, 0.01518, -0.00044, -0.00133, -5.0e-05, 0.00373, -0.00872, -0.01178, 0.00545, -0.00032, 0.00981, -0.01147, -0.01395, -0.01777, -0.00561, -0.00995, -0.01222, 0.01243, -0.01734, 0.01966, 0.01888, 0.00235, 0.00499, -0.00334, -0.00249, -0.00378, 0.0029, -0.00675, 0.00209, -0.01177, 0.00203, 0.00175, 0.00198, 0.00241, -0.00169, -0.00544, -0.00446, -0.00282, -0.00481, -0.00068, -0.00658, 0.00866, 0.00383, 0.00909, -0.00554, 0.00712, -0.00029, 0.0049, -0.00986, 0.00348, -0.00195, -0.00021, 0.00721, 0.00182, -0.00217, 0.01273, 0.02258, -0.00291, -0.00624, -0.01185, -0.00494, -0.00041, -0.00693, 0.00502, 0.01107, 0.01686, 0.00258, -0.00046, 0.00854, -0.01361, -0.00982, -0.01193, 0.0151, -0.01042, 0.01578, 0.00249, -0.00659, -0.00094, -0.01276, 0.00404, 0.00163, 0.00138, -0.03281, 0.01646, -0.00431, -0.01254, -0.00507, 0.00146, 0.0126, -0.0084, -0.00941, -0.00729, -0.01433, -0.00753, 0.02879, -0.01036, 0.00016, -0.00169, -0.01591, 0.01294, 0.00624, 0.00237, 0.00836, -4.0e-05, 0.01871, 0.02368, 0.00633, -0.00212, 0.00134, -0.00136, -0.00747, 0.00194, 0.00788, -0.01232, 0.0088, 0.00135, 4.0e-05, 0.01188, 0.00185, -0.00407, -0.01539, -0.01086, -0.02303, -0.00658, -0.00208, 0.00888, -0.01034, 0.00873, 0.00396, 0.00515, 0.0181, -0.00067, 0.00557, 0.01388, -0.00984, 0.00185, 0.00955, -0.00018, -0.00499, -0.00924, -0.00353, 0.00221, -0.01097, 0.0017, 0.01626, 0.01776, 0.00202, -0.01147, 0.00777, -0.00687, 0.0105, 0.00307, -0.00899, -0.00391, -0.00879, 0.00592, -0.00925, -0.00661, 0.00317, -0.00052, 0.01048, -0.00188, 0.00087, 0.00015, -0.00023, -0.01159, -0.01065]
    }
    ```

* example of folder structure with transformed documents

    ```
    /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
    ./data
    ./data/sport/
    ./data/sport/transformed/
    ./data/sport/transformed/LSI_PDLW/
    ./data/sport/transformed/LSI_PDLW/sport_train.json
    ./data/sport/transformed/LSI_PDLW/sport_dev.json
    ./data/sport/transformed/LSI_PDLW/sport_test.json
    ./data/non-sport/
    ./data/non-sport/transformed/
    ./data/non-sport/transformed/LSI_PDLW/
    ./data/non-sport/transformed/LSI_PDLW/non-sport_train.json
    ./data/non-sport/transformed/LSI_PDLW/non-sport_dev.json
    ./data/non-sport/transformed/LSI_PDLW/non-sport_test.json
    ```


### Train classification models by using the 'sklearn' python library for machine learning

* Scikit-learn algorithms included in our module
    - **DecisionTreeClassifier**: model that predicts the value of a target variable by learning simple decision rules inferred from the data features

    - **LogisticRegression**: fits a logistic model to data and makes predictions about the probability of an event (between 0 and 1); uses a logistic function and a one-vs-rest scheme

    - **Perceptron**:  classification algorithm that makes its predictions based on a linear predictor function combining a set of weights with the feature vector

    - naive bayes methods (**GaussianNB**, **MultinomialNB**, **BernoulliNB**): supervised learning algorithms based on applying Bayes' theorem with the 'naive' assumption of independence between every pair of features

    - support vector classifiers (**SVC**, **NuSVC**, **LinearSVC**): methods that select points in a transformed problem space that best separate classes into two groups; uses one-vs-all scheme

    - **MLPClassifier**: a type of feedforward artificial neural networks; it consists of at least three layers of nodes: one input, one hidden, one output;  except for the input nodes, each node is a neuron that uses a nonlinear activation function; MLP applies a supervised learning technique called backpropagation

    - **NearestNeighbors**: method that applies the majority vote of the nearest neighbors of each point

* Multiclass and multilabel algorithms:
    - all classifiers in scikit-learn do **multiclass** classification out-of-the-box
    - classifiers that are able to do **multilabel** classification: DecisionTreeClassifier, MLPClassifier, NearestNeighbors

* Models currently fed into the Ruby 'topic-discovery' module:
    - **LogisticRegression**
    - **MLPClassifier**

### Classify documents

* each classifier presented with a correct *features* input will output a 2-fields hash
    - category: the most probable document category
    - probas: the probabilities of all categories

    ```
    {
      'category': '',
      'probas': {}
    }
    ```

* example of document structure after applying a MLPClassifier model

    - fields: [id, url, title, content, **category**, **features**, **season**, season_prob]
    - mandatory existing field: **features**
    - new **season** field: designates the document's predicted category
    - new **season_prob** field: designates all class probabilities (mainly used for debugging)

    ```
    {
      "id": "936efc08f0ae581b96308d17eb92831d55113a0f49fbbf116afad651d2ca4ec8",
      "url": "http://www.eurosport.fr/football/serie-a-bresilienne/2012/goianense-botafogo_mtc511219/live.shtml",
      "title": "EN DIRECT / LIVE. Goianense - Botafogo - Série A brésilienne - 4 août 2012",
      "content": "série a brésilienne suivez en live la rencontre de football opposant goianense et botafogo ce match se déroule le août et débute à eurosport propose pour cette rencontre un suivi en direct permettant de connaître l' évolution du score et les actions importantes consultez la fiche détaillée pour goianense ainsi que celle pour botafogo découvrez également toute l' actualité du football calendrier résultats et classements",
      "category": "sport",
      "features": [0.02832, -0.01525, 0.01179, 0.01114, -0.00465, -0.008, 0.01005, -0.00499, -0.00411, 0.0124, -0.01721, -0.00087, -0.00397, -0.01209, -0.00299, 0.01902, -0.00585, 0.01529, 0.00888, -0.00991, 0.00804, 0.01055, -0.01189, 0.01149, -0.00273, -0.00986, 0.00387, -0.00877, -0.01642, 0.01911, 0.02927, -0.00526, 0.01441, 0.02177, -0.00109, -0.00062, -0.00017, -0.00292, -0.00979, 0.00442, -0.00083, -0.01265, 0.02042, -0.00227, -0.00175, 0.00137, -0.01096, 0.00679, -0.01313, 0.01634, -0.01437, -0.00029, 0.00377, -0.02218, -0.00123, -0.01269, 0.00041, -0.00273, 0.00082, -0.00881, 0.00548, 0.01159, -0.00842, -0.00148, 0.00857, -0.01069, 8.0e-05, 0.01469, 0.02005, -0.00082, -0.00318, 0.00095, -0.01587, -0.00632, -0.01129, -0.0141, 0.00192, 0.00539, -0.00052, 0.00912, 0.01197, 0.00542, 0.00982, -0.01238, 0.00801, -0.00936, -0.00145, -0.01494, -0.01227, -0.00368, 0.01864, -0.00684, 0.00614, -0.00581, -0.00145, -0.00675, 0.0066, 0.00909, -0.00466, -0.00258, -0.00324, -0.00766, 0.00159, 0.00739, 0.01032, 0.00291, -0.01062, 0.00908, -0.00035, -0.00097, -0.00694, 0.01152, -0.0048, -0.00121, -0.00647, 0.00285, -0.01277, -0.00291, -0.00231, -0.00138, -0.00821, 0.01933, -0.00163, 0.00068, 0.00064, 0.00701, 0.01045, -0.00904, 0.00094, 0.00763, 0.00517, -0.00065, -0.01055, 0.00558, 0.01518, -0.00044, -0.00133, -5.0e-05, 0.00373, -0.00872, -0.01178, 0.00545, -0.00032, 0.00981, -0.01147, -0.01395, -0.01777, -0.00561, -0.00995, -0.01222, 0.01243, -0.01734, 0.01966, 0.01888, 0.00235, 0.00499, -0.00334, -0.00249, -0.00378, 0.0029, -0.00675, 0.00209, -0.01177, 0.00203, 0.00175, 0.00198, 0.00241, -0.00169, -0.00544, -0.00446, -0.00282, -0.00481, -0.00068, -0.00658, 0.00866, 0.00383, 0.00909, -0.00554, 0.00712, -0.00029, 0.0049, -0.00986, 0.00348, -0.00195, -0.00021, 0.00721, 0.00182, -0.00217, 0.01273, 0.02258, -0.00291, -0.00624, -0.01185, -0.00494, -0.00041, -0.00693, 0.00502, 0.01107, 0.01686, 0.00258, -0.00046, 0.00854, -0.01361, -0.00982, -0.01193, 0.0151, -0.01042, 0.01578, 0.00249, -0.00659, -0.00094, -0.01276, 0.00404, 0.00163, 0.00138, -0.03281, 0.01646, -0.00431, -0.01254, -0.00507, 0.00146, 0.0126, -0.0084, -0.00941, -0.00729, -0.01433, -0.00753, 0.02879, -0.01036, 0.00016, -0.00169, -0.01591, 0.01294, 0.00624, 0.00237, 0.00836, -4.0e-05, 0.01871, 0.02368, 0.00633, -0.00212, 0.00134, -0.00136, -0.00747, 0.00194, 0.00788, -0.01232, 0.0088, 0.00135, 4.0e-05, 0.01188, 0.00185, -0.00407, -0.01539, -0.01086, -0.02303, -0.00658, -0.00208, 0.00888, -0.01034, 0.00873, 0.00396, 0.00515, 0.0181, -0.00067, 0.00557, 0.01388, -0.00984, 0.00185, 0.00955, -0.00018, -0.00499, -0.00924, -0.00353, 0.00221, -0.01097, 0.0017, 0.01626, 0.01776, 0.00202, -0.01147, 0.00777, -0.00687, 0.0105, 0.00307, -0.00899, -0.00391, -0.00879, 0.00592, -0.00925, -0.00661, 0.00317, -0.00052, 0.01048, -0.00188, 0.00087, 0.00015, -0.00023, -0.01159, -0.01065],
      "season": "sport",
      "season_prob":{"non-sport": 0.000002956, "sport": 0.9999970438936214}
    }
    ```

* example of folder structure with classified documents

    ```
    /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
    ./data
    ./data/sport/
    ./data/sport/p_classified/
    ./data/sport/p_classified/LSI_PDLW/
    ./data/sport/p_classified/LSI_PDLW/MLPClassifier_multiclass_offline_max/
    ./data/sport/p_classified/LSI_PDLW/MLPClassifier_multiclass_offline_max/sport_test.json
    ./data/non-sport/
    ./data/non-sport/p_classified/
    ./data/non-sport/p_classified/LSI_PDLW/
    ./data/non-sport/p_classified/LSI_PDLW/MLPClassifier_multiclass_offline_max/
    ./data/non-sport/p_classified/LSI_PDLW/MLPClassifier_multiclass_offline_max/non-sport_test.json
    ```


### Evaluate classification performance

* compare manual category tags (**category** field) with predicted category tags (**season** field)
* output statistics: per-class accuracy, per-class precision and recall, global accuracy, global confusion-matrix
* example of generated json stats file

    ```
    {
      "global-accuracy": "95.78%",
      "sport": {
        "recall": "96.79%",
        "precision": "94.34%"
      },
      "non-sport": {
        "recall": "94.89%",
        "precision": "97.11%"
      }
    }
    ```



## Usage

### ./bin/xi-ml-processdemands [arguments]

* train transformation models
* transform data
* train classification models
* classify data
* evaluate classification performance on classified documents

    ```
    usage: xi-ml-processdemands [-h] conf

    Train and test models based on requests

    positional arguments:
      conf        input config file (yml)

    optional arguments:
      -h, --help  show this help message and exit
    ```

### ./bin/xi-ml-plotdrawer [arguments]

* gather values of requested features on requested document categories
* draw value distributions: one feature's frequency histogram / a scatter plot between the common values of two features

    ```
    usage: xi-ml-plotdrawer [-h] conf

    Draw frequency-histograms/scatter-plots on document features

    positional arguments:
      conf        input config file (yml)

    optional arguments:
      -h, --help  show this help message and exit
    ```


## Local Execution

### Install requirements on your local machine

* check Dockerfile
* check gems/*.gemspec file(s)

### Test python code

* check syntax

    ```
    make syntax
    ```

* check lint

    ```
    make pylint
    ```

* launch unit tests

    ```
    make pytest
    ```

* generate html sphinx documentation (under xi-ml-doc)

    ```
    make sphinxdoc
    ```

* clean temporary files

    ```
    make clean
    ```

* locally build & install package

    ```
    make build
    make install
    make local-install
    ```


### Train and evaluate models

```
./bin/xi-ml-processdemands conf/fr/config.yml
```

Configuration

```
res: /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
classes:
  - sport
  - non-sport
preprocessings:
  - PDLW
dictionary:
  no_below: 5
  no_above: 0.75
  keep_n: 500000
transformations:
  LSI:
    num_topics: 300
    distributed: False
classifiers:
  LogisticRegression:
    classif_types:
      - multiclass
    train_types:
      - offline
    chunk_sizes:
      - -1
      - 10000
      - 1000000
    kwargs:
      penalty: l2
      solver: liblinear
      max_iter: 100
  MLPClassifier:
    classif_types:
      - multiclass
      - multilabel
    train_types:
      - offline
    chunk_sizes:
      - -1
      - 10000
      - 1000000
    kwargs:
      verbose: False
      solver: adam
      activation: relu
      max_iter: 200
      hidden_layer_sizes:
        - 100
execution:
  - train_trans
  - get_topics
  - transform_data
  - train_classifiers
  - test_classifiers
```

**Notes**

* the training might crash unless using a computer with enough RAM

* the preprocessed textual data should be present under the repository

    ```
    /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/data/
    ```

* the dictionary's filtering arguments (optional) can be adjusted through the *dictionary* option

    - ignore words seen in less than 5 documents
    - ignore words seen in more than 75% of documents
    - keep most frequent 500000 words

    ```
    dictionary:
      no_below: 5
      no_above: 0.75
      keep_n: 500000
    ```

* the LSI's initialization arguments (optional) can be adjusted through the *transformations[LSI]* option

    - train a LSI model on 300 topics
    - use a serial algorithm for training (only one worker)

    ```
    transformations:
      LSI:
        num_topics: 300
        distributed: False
    ```

* the LogisticRegression's initialization arguments (optional) can be adjusted through the *classifiers[LogisticRegression][kwargs]* option

    - use the L2 norm for the penalty
    - use the liblinear solver
    - execute maximum 100 iterations

    ```
    classifiers:
      LogisticRegression:
        kwargs:
          penalty: l2
          solver: liblinear
          max_iter: 100
    ```

* the MLP classifier's initialization arguments (optional) can be adjusted through the *classifiers[MLPClassifier][kwargs]* option

    - use the adam training algorithm
    - use the relu (rectified linear unit) activation function for hidden layers
    - execute maximum 200 iterations
    - use one single hidden layer with 100 neurons

    ```
    classifiers:
      MLPClassifier:
        kwargs:
          verbose: False
          solver: adam
          activation: relu
          max_iter: 200
          hidden_layer_sizes:
            - 100
    ```

### Visualize feature distribution

* frequency-histogram plot

    ```
    ./bin/xi-ml-plotdrawer conf/fr/config_plot_hist_2c.yml
    ```

    Configuration

    ```
    res: /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
    input:
      - data/sport/transformed/LSI_PDLW/sport_train.json
      - data/non-sport/transformed/LSI_PDLW/non-sport_train.json
    output: plots/histogram/
    features:
      - 0
      - 1
      - 2
      - 3
      - 4
    labels:
      - topic1
      - topic2
      - topic3
      - topic4
      - topic5
    optplot:
      type: histogram
      kwargs:
        bins: 20
        histtype: 'bar'
        range:
          - -1.0
          - 1.0
    optfig:
      size:
        - 18
        - 6
    ```

* scatterplot

    ```
    ./bin/xi-ml-plotdrawer conf/fr/config_plot_scatter_2c.yml
    ```

    Configuration

    ```
    res: /mnt/data/ml/docs/resources/fr/2categories/sn/es1preprod_24102016/
    input:
      - data/sport/transformed/LSI_PDLW/sport_train.json
      - data/non-sport/transformed/LSI_PDLW/non-sport_train.json
    output: plots/histogram/
    features:
      - 0
      - 1
      - 2
      - 3
      - 4
    labels:
      - topic1
      - topic2
      - topic3
      - topic4
      - topic5
    optplot:
      type: scatter
      kwargs:
        alpha: 0.8
        s: 10
    optfig:
      size:
        - 7
        - 7
    ```


## Docker execution

* model training and evaluation

    ```
    docker-compose run --rm ml-devel \
      ./bin/xi-ml-processdemands conf/fr/config.yml
    ```

* feature vizualization

    ```
    docker-compose run --rm ml-devel \
      ./bin/xi-ml-plotdrawer conf/fr/config_plot_scatter_2c.yml
    ```

