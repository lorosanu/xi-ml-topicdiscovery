# encoding: utf-8


require 'minitest/autorun'

$LOAD_PATH.unshift 'lib/'
require 'xi/ml'

class ClassifierTest < Minitest::Unit::TestCase

  def setup
    lr_file = File.join(File.dirname(__FILE__), 'example_lr.json')

    Xi::ML::Tools::Utils.check_file_readable!(lr_file)

    @lr_classifier = Xi::ML::Classify::Classifier.new(
      'LogisticRegression', lr_file)

    @doc_sport = '0.1435505 -0.1330716 0.0152118 -0.0124044 -0.0402427 '\
      '-0.127904 -0.0968397 -0.0015302 -0.0121994 0.1018563 -0.1142461 '\
      '0.0938823 0.0162849 -0.0376602 -0.0956969 -0.0166363 -0.0544454 '\
      '-0.01301 -0.0338447 0.1651503 0.1009132 0.0535997 0.0116646 '\
      '-0.015924 -0.1639595 0.1085821 0.2189997 -0.0084682 -0.046439 '\
      '-0.1877413 0.0953012 0.103366 -0.032233 -0.0258595 -0.0040424 '\
      '0.0816343 0.0659345 -0.061133 -0.0195373 -0.0682278 0.0685381 '\
      '-0.0180449 0.0316821 0.0768489 -0.02622 -0.035417 0.1177703 '\
      '-0.0647359 0.0374275 0.0415729 0.0002445 -0.0418986 -0.1771863 '\
      '-0.024061 -0.0081405 0.0520135 0.2348016 0.10526 -0.072654 '\
      '0.1250983 -0.1425046 -0.0844605 -0.013556 0.0565355 0.0424556 '\
      '-0.0533164 0.071324 -0.0887937 0.0535342 -0.0904968 -0.0633556 '\
      '0.0649063 0.0375807 0.0805776 0.1083628 0.0120349 -0.0105984 '\
      '0.0046764 -0.0734194 0.0701729 0.0430695 0.0361587 -0.0730261 '\
      '0.0031009 -0.1053464 0.0700964 0.00935 -0.0110064 -0.0398512 '\
      '-0.0939598 -0.0201498 -0.0125911 -0.0208458 0.0058175 0.0197002 '\
      '0.082777 0.0137323 -0.0543628 -0.0058821 -0.0292691 0.0391348 '\
      '0.0477857 0.0292908 0.0094838 -0.070226 -0.0555554 0.0286882 '\
      '-0.0242669 0.0364725 0.0389968 0.0278251 -0.0050212 0.0086891 '\
      '-0.0252961 -0.0218842 0.0137787 0.0136411 0.0204289 -0.0085726 '\
      '0.0062179 0.0199603 -0.0069774 0.0343023 -0.0006276 -0.0314004 '\
      '-0.0353299 0.0150067 0.0062094 -0.0121465 0.0134154 -0.0274811 '\
      '-0.0381085 -0.0077489 0.0845393 -0.0213251 -0.0008495 -0.0091357 '\
      '-0.0128043 0.009062 0.057498 -0.0101596 -0.0290669 -0.0203039 '\
      '0.0228689 -0.0346947 0.001191 0.0508569 0.0163066 0.036659 '\
      '-0.0350493 -0.0234205 -0.0324089 -0.0038275 -0.0061257 0.0042606 '\
      '0.0527647 0.0062374 -0.0105013 0.0164086 -0.0079278 -0.0229416 '\
      '0.0219867 0.0340756 -0.0260688 0.0127569 -0.0720055 0.0298778 '\
      '-0.0378862 0.0027794 0.0897511 -0.0406479 0.0127908 -0.0062106 '\
      '-0.0090329 -0.0244614 -0.0409905 -0.0143711 0.0183087 0.013507 '\
      '-0.0156506 0.0088395 -0.0154459 -0.0042495 -0.0281538 -0.0044883 '\
      '-0.0026598 -0.0202111 -0.0481196 -0.011747 -0.0015012 0.0087674 '\
      '0.0305529 -0.0063498 0.0001495 -0.0179683 0.0008307 -0.0178883 '\
      '0.0193222 0.0415813 0.0219492 0.0427386 0.0013448 -0.0035343 '\
      '0.0524576 0.034502 -0.0372608 0.0390751 0.0328962 0.0181826 '\
      '-0.0381363 -0.0241632 -0.0225571 -0.0028953 0.0024739 0.0083294 '\
      '0.0021245 0.0056255 -0.0112073 -0.0735107 0.0274257 -0.0217661 '\
      '-0.0088008 -0.0047957 -0.0005377 0.0162225 -0.0180968 0.0243624 '\
      '0.0004584 0.01101 -0.010723 -0.0332195 0.0202606 -0.006362 '\
      '-0.0044482 0.0456843 -0.0049417 -0.0045361 0.0454706 0.0293418 '\
      '0.0041069 -0.0213927 -0.0230116 0.0058534 -0.0095324 -0.0111703 '\
      '0.0051919 0.0075185 -0.0093336 -0.0130119 -0.0121244 0.0070321 '\
      '-0.0224501 0.0120491 0.0493877 -0.0158969 0.0080749 -0.0271144 '\
      '0.0117225 0.0001711 -0.0023754 0.0072192 0.0024325 -0.009007 '\
      '0.0253329 -0.0040598 -0.0044694 -0.0385162 0.0085549 -0.0035942 '\
      '-0.042294 -0.0189926 -0.0092112 0.0001283 0.0096111 0.0256051 '\
      '0.0006475 -0.0233825 -0.0038587 0.0037489 -0.0160905 0.0150337 '\
      '-0.0094322 -0.0013103 0.0183795 0.0063234 0.0027387 -0.0014682 '\
      '-0.0055953 0.0114508 -0.0129937 0.0153524 -0.0028618 -0.0403619 '\
      '0.0182898 -0.0037458 -0.0247988 0.0062461 0.0187524 -0.0149033 '\
      '-0.0174524'

    @doc_non_sport = '0.1142101 0.0049299 -0.0093673 0.000857 0.0043937 '\
      '-0.0143765 -0.0457665 0.0271295 0.0225138 0.0502204 -0.0201173 '\
      '-0.0191687 -0.0169534 -0.0469677 0.1085765 -0.0607128 0.0722534 '\
      '0.0211343 0.030318 -0.0298999 -0.0077842 -0.0383963 -0.0202756 '\
      '0.0130388 0.0469321 0.0316001 -0.0058115 -0.0143961 -0.0249775 '\
      '0.0260412 -0.0238657 0.030875 -0.0080281 -0.0441539 -0.0547783 '\
      '0.0129937 0.0112513 -0.0145322 -0.0154287 -0.0170284 -0.0196239 '\
      '0.0218854 -0.0199215 0.0202344 0.0122842 0.0239079 -0.0107147 '\
      '-0.0011237 0.047273 -0.0053519 0.0176378 0.0603938 0.0205699 '\
      '0.0047557 -0.0476337 -0.0099155 0.0776252 0.0142012 -0.0223909 '\
      '0.0283332 0.0305773 -0.0029194 -0.0039012 -0.0267897 -0.0732982 '\
      '0.015814 0.0026055 -0.0483485 -0.0121334 0.00561 0.0228735 -0.0365333 '\
      '-0.0413622 0.0637523 0.0064489 0.1278503 -0.0655336 -0.0155522 '\
      '-0.1258047 0.0430577 0.0382315 0.0877925 0.0479685 -0.0069648 '\
      '0.0695624 0.0871482 -0.0324238 -0.051393 -0.0447333 0.0583849 '\
      '0.1261047 0.0515355 0.0013159 0.0465231 0.0228176 -0.078589 '\
      '-0.0250132 0.0770667 -0.0610062 -0.0214779 -0.0363716 0.0295714 '\
      '-0.0125718 0.0216379 -0.0357409 0.0966197 -0.0130846 -0.1361291 '\
      '-0.0938224 0.0475192 -0.0220367 0.0106865 -0.0273085 -0.151474 '\
      '0.0094909 -0.0509818 -0.0266008 0.0062724 -0.065803 -0.1055553 '\
      '0.0529054 0.0217145 -0.0562331 0.1212446 -0.0605566 -0.0074309 '\
      '0.0261753 0.0175023 -0.0293532 -0.0157275 -0.0381099 -0.0266299 '\
      '0.0320576 0.0509362 0.024862 -0.0580997 0.0720001 0.0083907 '\
      '-0.0363678 -0.0268032 -0.0014852 -0.0110905 -0.0552537 0.013653 '\
      '0.0124259 0.0716131 -0.0182117 -0.0169143 -0.0119229 -0.0750312 '\
      '-0.0115809 -0.0040916 -0.0145581 -0.0243567 -0.0145077 0.0069527 '\
      '0.0135389 -0.0030077 0.0211296 0.0050975 0.0403442 -0.0222162 '\
      '-0.0344903 0.0492766 -0.0043164 0.0117864 0.0085345 0.0173434 '\
      '0.0351081 -0.0345709 0.0075651 0.0131009 0.0899904 -0.0177021 '\
      '-0.0304295 0.0024143 -0.0688613 -0.0004882 -0.0224638 -0.0401381 '\
      '-0.0219454 -0.026677 -0.0185548 0.0048789 0.0026337 -0.0080581 '\
      '0.0151114 0.0156047 0.0147652 -0.001147 -0.0049075 0.0085324 '\
      '-0.0048362 0.0046822 0.0137077 -0.0089533 -0.0125394 0.000551 '\
      '-0.0222692 0.0226891 -0.0116039 0.0016504 0.0436312 0.0174939 '\
      '-0.0002334 0.0189234 0.013587 0.0117992 0.0002783 0.0204514 '\
      '-0.0071642 0.0177476 -0.016803 -0.0556738 -0.0215485 -0.0031902 '\
      '-0.0054471 -0.0006299 0.0027251 -0.0382484 0.0165338 -0.0055218 '\
      '0.0059955 -0.0022448 0.0042367 -0.0096177 -0.0246325 -0.0179323 '\
      '-0.0012141 0.02134 0.0167431 -0.0367404 -0.0036739 -0.0001258 '\
      '-0.0167153 -0.0043945 -0.0237933 0.0205696 -0.0199224 0.001016 '\
      '-0.0128419 0.0142308 0.0148846 -0.0057101 -0.0009156 -0.0179544 '\
      '-0.0397557 0.0062987 -0.0132494 -0.0264617 -0.000882 0.0199543 '\
      '0.0078297 -0.0058533 -0.0091416 0.0060186 0.0218884 0.0206684 '\
      '-0.0098821 0.0229138 -0.0171907 0.0194105 0.0213952 -0.0062556 '\
      '-0.0065185 0.008044 -0.0125053 -0.0020156 0.0097408 0.0038826 '\
      '0.0158833 0.0022429 -0.0001929 -0.0280988 0.0077408 -0.0070129 '\
      '0.0040754 0.0042564 0.0108745 -0.0064081 0.0043961 0.0095799 '\
      '0.0116141 0.0294388 -0.0091256 -0.0020578 -0.0128881 -0.0001023 '\
      '0.0114016 0.0076792 -0.0008366 0.0073319 0.009652 -0.0001569 '\
      '-0.0050291 -0.0314287 -0.0151907 -0.0105736 0.0087181 -0.0141146'
  end

  def test_lr_sport
    probas = @lr_classifier.classify_doc(@doc_sport)
    rprobas = {
      category: 'sport',
      probas: {
        'sport' => 0.9024615677212438,
        'non-sport' => 0.09753843227875625,
      },
    }

    probas[:probas] = probas[:probas].map{|k, v| [k, '%.6f' % (v)] }.to_h
    rprobas[:probas] = rprobas[:probas].map{|k, v| [k, '%.6f' % (v)] }.to_h

    assert_equal rprobas, probas
  end

  def test_lr_non_sport
    probas = @lr_classifier.classify_doc(@doc_non_sport)
    rprobas = {
      category: 'non-sport',
      probas: {
        'sport' => 0.15439201579094589,
        'non-sport' => 0.8456079842090541,
      },
    }

    probas[:probas] = probas[:probas].map{|k, v| [k, '%.6f' % (v)] }.to_h
    rprobas[:probas] = rprobas[:probas].map{|k, v| [k, '%.6f' % (v)] }.to_h

    assert_equal rprobas, probas
  end

end
